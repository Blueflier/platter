<!-- --- DEV B owns this file --- -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Platter</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: #e8f0fe;
      color: #1e293b;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ---- 3D background canvas ---- */
    #bg-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    /* ---- 3D config panel (Ctrl+D) ---- */
    .scene-config {
      display: none;
      position: fixed;
      top: 1rem;
      right: 1rem;
      width: 260px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(12px);
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 1.25rem;
      z-index: 200;
      box-shadow: 0 8px 32px rgba(30,41,59,0.1);
      font-size: 0.8rem;
      color: #475569;
    }

    .scene-config.open { display: block; }

    .scene-config h3 {
      font-size: 0.85rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .scene-config h3 span {
      font-size: 0.7rem;
      color: #94a3b8;
      font-weight: 400;
    }

    .cfg-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.6rem;
    }

    .cfg-row label {
      font-size: 0.78rem;
      color: #64748b;
    }

    .cfg-row input[type="range"] {
      width: 110px;
      accent-color: #6b9cf7;
    }

    .cfg-row input[type="checkbox"] {
      accent-color: #6b9cf7;
    }

    .cfg-row .cfg-val {
      font-size: 0.72rem;
      color: #94a3b8;
      min-width: 32px;
      text-align: right;
    }

    /* ---- layout ---- */
    .app {
      max-width: 860px;
      margin: 0 auto;
      padding: 2.5rem 1.5rem 4rem;
      position: relative;
      z-index: 1;
    }

    .header {
      display: flex;
      align-items: center;
      margin-bottom: 2rem;
    }

    .logo {
      display: flex;
      align-items: center;
      font-size: 1.35rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: #1e293b;
      text-decoration: none;
    }
    .logo img {
      height: 4.5rem;
      width: auto;
      margin-right: 0.5rem;
      vertical-align: middle;
    }

    /* ---- search ---- */
    .search-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .search-wrap {
      position: relative;
      flex: 1;
    }

    .search-wrap svg {
      position: absolute;
      left: 1.1rem;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: #94a3b8;
      pointer-events: none;
    }

    #searchInput {
      width: 100%;
      padding: 0.95rem 1rem 0.95rem 3rem;
      font-size: 1.05rem;
      font-family: inherit;
      color: #1e293b;
      background: #ffffff;
      border: 1px solid #cbd5e1;
      border-radius: 16px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    #searchInput::placeholder { color: #94a3b8; }
    #searchInput:focus {
      border-color: #93b5f7;
      box-shadow: 0 0 0 3px rgba(147,181,247,0.25);
    }

    /* typing placeholder */
    .search-wrap .typed-placeholder {
      position: absolute;
      left: 3rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.05rem;
      color: #94a3b8;
      pointer-events: none;
      white-space: nowrap;
      overflow: hidden;
    }

    .search-wrap .typed-placeholder .cursor {
      display: inline-block;
      width: 1px;
      height: 1.1em;
      background: #94a3b8;
      vertical-align: text-bottom;
      margin-left: 1px;
      animation: blink 1s step-end infinite;
    }

    @keyframes blink {
      50% { opacity: 0; }
    }

    /* info button */
    .info-btn {
      width: 42px;
      height: 42px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ffffff;
      border: 1px solid #cbd5e1;
      border-radius: 14px;
      color: #64748b;
      cursor: pointer;
      font-size: 1.05rem;
      font-weight: 600;
      font-family: 'Georgia', serif;
      font-style: italic;
      transition: border-color 0.15s, color 0.15s, background 0.15s;
    }

    .info-btn:hover {
      border-color: #93b5f7;
      color: #475569;
      background: #f0f5ff;
    }

    /* ---- info modal ---- */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(30,41,59,0.3);
      backdrop-filter: blur(4px);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.open { display: flex; }

    .modal {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      padding: 2rem;
      max-width: 520px;
      width: 90%;
      position: relative;
      animation: modalIn 0.2s ease-out;
      box-shadow: 0 20px 60px rgba(30,41,59,0.12);
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95) translateY(8px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      color: #64748b;
      cursor: pointer;
      font-size: 1.1rem;
      transition: background 0.15s;
    }

    .modal-close:hover { background: #e2e8f0; }

    .modal h2 {
      font-size: 1.15rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #1e293b;
    }

    .modal ol {
      padding-left: 1.3rem;
      color: #64748b;
      font-size: 0.9rem;
      line-height: 1.8;
    }

    .modal ol li { margin-bottom: 0.4rem; }
    .modal ol li strong { color: #1e293b; font-weight: 500; }

    .modal p.hint {
      margin-top: 1rem;
      font-size: 0.82rem;
      color: #94a3b8;
      font-style: italic;
    }

    /* ---- live log ---- */
    .log-panel {
      display: none;
      margin-bottom: 1rem;
      max-height: 200px;
      overflow-y: auto;
      background: #1e293b;
      border-radius: 12px;
      padding: 0.75rem 1rem;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 0.75rem;
      line-height: 1.7;
      color: #94a3b8;
    }

    .log-panel.open { display: block; }

    .log-panel .log-line {
      white-space: pre-wrap;
      word-break: break-word;
    }

    .log-panel .log-line .log-time {
      color: #475569;
      margin-right: 0.5rem;
    }

    .log-panel .log-line.log-highlight {
      color: #6b9cf7;
    }

    .log-panel .log-line.log-success {
      color: #34d399;
    }

    .log-panel .log-line.log-error {
      color: #f87171;
    }

    /* ---- 3D progress bar ---- */
    #progressWrap {
      display: none;
      position: relative;
      height: 60px;
      margin-bottom: 1rem;
    }

    #progressWrap.open { display: block; }

    #progress-canvas {
      width: 100%;
      height: 40px;
      display: block;
    }

    /* ---- results area ---- */
    .results-area {
      margin-top: 0.5rem;
    }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .results-header .status {
      font-size: 0.85rem;
      color: #64748b;
      min-height: 1.3em;
    }

    .results-header .status .spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #e2e8f0;
      border-top-color: #6b9cf7;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
      margin-right: 0.4rem;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .saved-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.45rem 1rem;
      font-size: 0.82rem;
      font-weight: 500;
      color: #64748b;
      background: #ffffff;
      border: 1px solid #cbd5e1;
      border-radius: 9999px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .saved-toggle:hover { background: #f0f5ff; }
    .saved-toggle.active { color: #7c6bc4; border-color: rgba(124,107,196,0.4); }

    .saved-toggle svg {
      width: 14px;
      height: 14px;
    }

    /* ---- cards ---- */
    .cards { display: flex; flex-direction: column; gap: 0.75rem; }

    .card {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 18px;
      padding: 1.25rem 1.5rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      border-color: #c7d7f5;
      box-shadow: 0 4px 16px rgba(107,156,247,0.08);
    }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .card-name {
      font-size: 1.05rem;
      font-weight: 600;
      color: #1e293b;
    }

    .card-rating {
      flex-shrink: 0;
      font-size: 0.8rem;
      color: #64748b;
      white-space: nowrap;
    }

    .card-rating .star { color: #f59e0b; }

    .card-meta {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-top: 0.3rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .card-meta .separator {
      color: #cbd5e1;
    }

    .copy-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.2rem 0.55rem;
      font-size: 0.78rem;
      font-family: inherit;
      color: #475569;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
      white-space: nowrap;
    }

    .copy-chip:hover {
      background: #e8eef6;
      border-color: #c7d7f5;
    }

    .copy-chip.copied {
      background: #d1fae5;
      border-color: #a7f3d0;
      color: #065f46;
    }

    .copy-chip svg {
      width: 12px;
      height: 12px;
      flex-shrink: 0;
    }

    .call-instead {
      margin-top: 0.5rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.82rem;
      background: #fef9e7;
      border: 1px solid #fde68a;
      border-radius: 12px;
      color: #92400e;
    }

    /* card actions */
    .card-actions {
      margin-top: 0.75rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.5rem 1rem;
      font-size: 0.82rem;
      font-weight: 500;
      font-family: inherit;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }

    .btn:active { transform: scale(0.97); }

    .btn-primary {
      background: #6b9cf7;
      color: #ffffff;
    }

    .btn-primary:hover { background: #5a8be6; }

    .btn-ghost {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
    }

    .btn-ghost:hover { background: #e8eef6; }

    .btn-copied {
      background: #d1fae5;
      color: #065f46;
    }

    /* ---- card detail popover on hover ---- */
    .card {
      position: relative;
    }
    .card-detail-popover {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      box-shadow: 0 12px 40px rgba(30,41,59,0.12);
      z-index: 40;
      animation: popIn 0.15s ease-out;
      font-size: 0.8rem;
      color: #475569;
      line-height: 1.5;
    }
    .card:hover .card-detail-popover {
      display: block;
    }
    .card-detail-popover dt {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.6rem;
    }
    .card-detail-popover dt:first-child {
      margin-top: 0;
    }
    .card-detail-popover dd {
      margin: 0.15rem 0 0 0;
    }

    /* ---- email hover popover ---- */
    .email-popover-wrap {
      position: relative;
      display: inline-flex;
    }

    .email-popover {
      display: none;
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      width: 340px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 1rem;
      box-shadow: 0 12px 40px rgba(30,41,59,0.12);
      z-index: 50;
      animation: popIn 0.15s ease-out;
    }

    .email-popover::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: #ffffff;
    }

    .email-popover::before {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 9px solid transparent;
      border-top-color: #e2e8f0;
    }

    @keyframes popIn {
      from { opacity: 0; transform: translateX(-50%) translateY(4px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .email-popover-wrap:hover .email-popover,
    .email-popover-wrap.popover-active .email-popover {
      display: block;
    }

    .email-popover-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #94a3b8;
      margin-bottom: 0.5rem;
    }

    .email-popover-body {
      font-size: 0.8rem;
      line-height: 1.6;
      color: #475569;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }

    /* building state */
    .card.building {
      opacity: 0.6;
    }

    .card.building .card-name::after {
      content: '';
      display: inline-block;
      width: 10px;
      height: 10px;
      border: 2px solid #e2e8f0;
      border-top-color: #6b9cf7;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-left: 0.5rem;
      vertical-align: middle;
    }

    /* saved section */
    .saved-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e2e8f0;
    }

    .saved-section h3 {
      font-size: 0.85rem;
      color: #94a3b8;
      font-weight: 500;
      margin-bottom: 1rem;
    }

    .card.saved {
      opacity: 0.55;
    }

    .card.saved:hover { opacity: 0.75; }

    /* fade in */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card { animation: fadeIn 0.3s ease-out; }
  </style>
</head>
<body>
  <canvas id="bg-canvas"></canvas>

  <!-- 3D config panel (Ctrl+D) -->
  <div class="scene-config" id="sceneConfig">
    <h3>Scene Config <span>Ctrl+D</span></h3>
    <div class="cfg-row">
      <label>Show 3D</label>
      <input type="checkbox" id="cfgShow" checked>
    </div>
    <div class="cfg-row">
      <label>Rotation Speed</label>
      <input type="range" id="cfgRotSpeed" min="0" max="100" value="5">
      <span class="cfg-val" id="cfgRotSpeedVal">0.0005</span>
    </div>
    <div class="cfg-row">
      <label>Camera Distance</label>
      <input type="range" id="cfgCamDist" min="2" max="30" value="13">
      <span class="cfg-val" id="cfgCamDistVal">13</span>
    </div>
    <div class="cfg-row">
      <label>Camera Height</label>
      <input type="range" id="cfgCamHeight" min="-10" max="20" value="5">
      <span class="cfg-val" id="cfgCamHeightVal">5</span>
    </div>
    <div class="cfg-row">
      <label>Model Scale</label>
      <input type="range" id="cfgScale" min="1" max="100" value="20">
      <span class="cfg-val" id="cfgScaleVal">2.0</span>
    </div>
    <div class="cfg-row">
      <label>Light Intensity</label>
      <input type="range" id="cfgLightInt" min="0" max="100" value="73">
      <span class="cfg-val" id="cfgLightIntVal">2.2</span>
    </div>
    <div class="cfg-row">
      <label>Opacity</label>
      <input type="range" id="cfgOpacity" min="0" max="100" value="64">
      <span class="cfg-val" id="cfgOpacityVal">0.64</span>
    </div>
    <h3 style="margin-top:0.75rem">Progress Bar <span>debug</span></h3>
    <div class="cfg-row">
      <label>Bar Height</label>
      <input type="range" id="cfgBarH" min="10" max="200" value="40">
      <span class="cfg-val" id="cfgBarHVal">40</span>
    </div>
    <div class="cfg-row">
      <label>Seg Height</label>
      <input type="range" id="cfgSegH" min="5" max="100" value="40">
      <span class="cfg-val" id="cfgSegHVal">0.40</span>
    </div>
    <div class="cfg-row">
      <label>Seg Depth</label>
      <input type="range" id="cfgSegD" min="5" max="100" value="25">
      <span class="cfg-val" id="cfgSegDVal">0.25</span>
    </div>
    <div class="cfg-row">
      <label>Gap</label>
      <input type="range" id="cfgBarGap" min="0" max="50" value="6">
      <span class="cfg-val" id="cfgBarGapVal">0.06</span>
    </div>
    <div class="cfg-row">
      <label>Frustum</label>
      <input type="range" id="cfgFrustum" min="10" max="100" value="40">
      <span class="cfg-val" id="cfgFrustumVal">4.0</span>
    </div>
    <div class="cfg-row">
      <label>X</label>
      <input type="range" id="cfgBarX" min="-300" max="300" value="0">
      <span class="cfg-val" id="cfgBarXVal">0.0</span>
    </div>
    <div class="cfg-row">
      <label>Y</label>
      <input type="range" id="cfgBarY" min="-300" max="300" value="0">
      <span class="cfg-val" id="cfgBarYVal">0.0</span>
    </div>
    <div class="cfg-row">
      <label>Z</label>
      <input type="range" id="cfgBarZ" min="-300" max="300" value="0">
      <span class="cfg-val" id="cfgBarZVal">0.0</span>
    </div>
    <div class="cfg-row">
      <label>Scale</label>
      <input type="range" id="cfgBarScale" min="10" max="300" value="100">
      <span class="cfg-val" id="cfgBarScaleVal">1.0</span>
    </div>
  </div>

  <div class="app">
    <!-- header: logo + name -->
    <div class="header">
      <a href="/" class="logo"><img src="logo.png" alt="">Platter</a>
    </div>

    <!-- search row with info button -->
    <div class="search-row">
      <div class="search-wrap">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
        <input type="text" id="searchInput" placeholder="" autofocus>
        <div class="typed-placeholder" id="typedPlaceholder"><span id="typedText"></span><span class="cursor"></span></div>
      </div>
      <button class="info-btn" id="infoBtn" title="How to use Platter">i</button>
    </div>

    <!-- info modal -->
    <div class="modal-overlay" id="infoModal">
      <div class="modal">
        <button class="modal-close" id="modalClose">&times;</button>
        <h2>How to use Platter</h2>
        <ol>
          <li><strong>Search</strong> for a type of business and location (e.g. "bakeries in Oakland")</li>
          <li>Platter finds businesses that <strong>don't have a website</strong> yet</li>
          <li>We <strong>auto-generate a website</strong> for each one and draft an outreach email</li>
          <li><strong>Copy the email</strong> and send it to the business owner</li>
          <li>Use <strong>Save for Later</strong> to bookmark businesses you want to follow up on</li>
        </ol>
        <p class="hint">Tip: Be specific with your search to get the best results.</p>
      </div>
    </div>

    <!-- live log -->
    <div class="log-panel" id="logPanel"></div>

    <!-- 3D progress bar -->
    <div id="progressWrap">
      <canvas id="progress-canvas"></canvas>
    </div>

    <!-- results area with saved toggle -->
    <div class="results-area">
      <div class="results-header">
        <div class="status" id="status"></div>
        <button class="saved-toggle" id="savedToggle">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z"/></svg>
          <span id="savedToggleLabel">Show Saved</span>
          <span id="savedCount">0</span>
        </button>
      </div>

      <div class="cards" id="cards"></div>

      <div class="saved-section" id="savedSection" style="display:none;">
        <h3>Saved for Later</h3>
        <div class="cards" id="savedCards"></div>
      </div>
    </div>
  </div>

  <script>
    const searchInput = document.getElementById('searchInput');
    const statusEl = document.getElementById('status');
    const cardsEl = document.getElementById('cards');
    const savedSection = document.getElementById('savedSection');
    const savedCardsEl = document.getElementById('savedCards');
    const savedToggle = document.getElementById('savedToggle');
    const savedCountEl = document.getElementById('savedCount');
    const savedToggleLabel = document.getElementById('savedToggleLabel');
    const logPanel = document.getElementById('logPanel');
    const infoBtn = document.getElementById('infoBtn');
    const infoModal = document.getElementById('infoModal');
    const modalClose = document.getElementById('modalClose');
    const typedPlaceholder = document.getElementById('typedPlaceholder');
    const typedText = document.getElementById('typedText');

    let currentSearchId = null;
    let pollTimer = null;
    let savedVisible = false;
    let savedItems = [];
    let lastLogTime = 0;

    // ---- progress bar state ----
    window.progressStage = -1;
    const progressWrap = document.getElementById('progressWrap');
    const stageRegexes = [
      /Searching Google Places/,
      /Checking for existing websites|has website|no website found/,
      /Researching business online|Waiting for research|Research complete/,
      /Generating website/,
      /Website deployed|All businesses processed/,
    ];
    function deriveStage(msg) {
      for (let i = stageRegexes.length - 1; i >= 0; i--) {
        if (stageRegexes[i].test(msg)) return i;
      }
      return -1;
    }

    function setProgressStage(idx) {
      if (idx <= window.progressStage) return;
      window.progressStage = idx;
      if (typeof window.updateProgressBar === 'function') {
        window.updateProgressBar(idx);
      }
    }

    function appendLogs(logs) {
      if (!logs || !logs.length) return;
      logPanel.classList.add('open');
      progressWrap.classList.add('open');
      for (const entry of logs) {
        const line = document.createElement('div');
        line.className = 'log-line';
        // color coding
        if (entry.msg.includes('deployed') || entry.msg.includes('complete') || entry.msg.includes('All businesses')) {
          line.classList.add('log-success');
        } else if (entry.msg.includes('failed') || entry.msg.includes('error') || entry.msg.includes('timed out')) {
          line.classList.add('log-error');
        } else if (entry.msg.includes('Generating') || entry.msg.includes('Searching') || entry.msg.includes('Researching')) {
          line.classList.add('log-highlight');
        }
        const time = new Date(entry.t).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        line.innerHTML = `<span class="log-time">${time}</span>${esc(entry.msg)}`;
        logPanel.appendChild(line);
        if (entry.t > lastLogTime) lastLogTime = entry.t;

        // derive progress stage
        const s = deriveStage(entry.msg);
        if (s >= 0) setProgressStage(s);
      }
      logPanel.scrollTop = logPanel.scrollHeight;
    }

    // ---- typing placeholder animation ----
    const placeholderExamples = [
      'nail salons in San Francisco',
      'taquerias in the Mission District',
      'barber shops in Oakland',
      'yoga studios in Berkeley',
      'auto repair in San Jose',
      'bakeries in Palo Alto',
      'pet groomers in Fremont',
      'flower shops in Walnut Creek',
      'tattoo parlors in San Mateo',
      'coffee roasters in Santa Cruz',
    ];

    let exampleIndex = 0;
    let charIndex = 0;
    let isDeleting = false;
    let typeTimer = null;

    function typeLoop() {
      // hide when user is typing
      if (searchInput.value.length > 0) {
        typedPlaceholder.style.display = 'none';
        typeTimer = setTimeout(typeLoop, 300);
        return;
      }
      typedPlaceholder.style.display = '';

      const current = placeholderExamples[exampleIndex];

      if (!isDeleting) {
        charIndex++;
        typedText.textContent = current.slice(0, charIndex);
        if (charIndex >= current.length) {
          // pause at full text
          typeTimer = setTimeout(() => { isDeleting = true; typeLoop(); }, 2000);
          return;
        }
        typeTimer = setTimeout(typeLoop, 60 + Math.random() * 40);
      } else {
        charIndex--;
        typedText.textContent = current.slice(0, charIndex);
        if (charIndex <= 0) {
          isDeleting = false;
          exampleIndex = (exampleIndex + 1) % placeholderExamples.length;
          typeTimer = setTimeout(typeLoop, 400);
          return;
        }
        typeTimer = setTimeout(typeLoop, 30);
      }
    }

    typeLoop();

    // hide placeholder on focus if empty (cursor still shows)
    searchInput.addEventListener('input', () => {
      typedPlaceholder.style.display = searchInput.value.length > 0 ? 'none' : '';
    });

    // ---- info modal ----
    infoBtn.addEventListener('click', () => { infoModal.classList.add('open'); });
    modalClose.addEventListener('click', () => { infoModal.classList.remove('open'); });
    infoModal.addEventListener('click', (e) => {
      if (e.target === infoModal) infoModal.classList.remove('open');
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') infoModal.classList.remove('open');
    });

    // --- search triggers (Enter only) ---
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const q = searchInput.value.trim();
        if (q) startSearch(q);
      }
    });

    // --- saved toggle ---
    savedToggle.addEventListener('click', () => {
      savedVisible = !savedVisible;
      savedToggle.classList.toggle('active', savedVisible);
      savedToggleLabel.textContent = savedVisible ? 'Hide Saved' : 'Show Saved';
      savedSection.style.display = savedVisible ? 'block' : 'none';
    });

    // load generated sites on startup (only if no active search)
    const resumeSearchId = sessionStorage.getItem('activeSearchId');
    if (!resumeSearchId) {
      loadGenerated();
    }

    async function loadGenerated() {
      try {
        const res = await fetch('/api/generated');
        const sites = await res.json();
        cardsEl.innerHTML = '';
        if (sites.length === 0) {
          statusEl.textContent = 'No generated sites yet. Run a search to get started.';
          return;
        }
        statusEl.textContent = `${sites.length} generated`;
        for (const site of sites) {
          renderCard(site, cardsEl, false);
        }
      } catch {
        statusEl.textContent = 'Failed to load generated sites.';
      }
    }

    // --- resume in-progress search on reload ---
    if (resumeSearchId) {
      currentSearchId = resumeSearchId;
      statusEl.innerHTML = '<span class="spinner"></span> Resuming...';
      logPanel.classList.add('open');
      progressWrap.classList.add('open');
      // fetch all logs from the beginning to rebuild state
      lastLogTime = 0;
      pollStatus(resumeSearchId);
    }

    // --- search flow ---
    async function startSearch(query) {
      // reset
      if (pollTimer) clearInterval(pollTimer);
      cardsEl.innerHTML = '';
      savedCardsEl.innerHTML = '';
      savedItems = [];
      lastLogTime = 0;
      logPanel.innerHTML = '';
      logPanel.classList.remove('open');
      window.progressStage = -1;
      progressWrap.classList.remove('open');

      if (typeof window.updateProgressBar === 'function') window.updateProgressBar(-1);
      updateSavedBadge();
      statusEl.innerHTML = '<span class="spinner"></span> Starting...';

      try {
        const res = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });
        const { search_id } = await res.json();
        currentSearchId = search_id;
        sessionStorage.setItem('activeSearchId', search_id);
        pollStatus(search_id);
      } catch (err) {
        statusEl.textContent = 'Search failed. Try again.';
      }
    }

    function pollStatus(searchId) {
      pollTimer = setInterval(async () => {
        try {
          const res = await fetch(`/api/search/${searchId}/status?since=${lastLogTime}`);
          const data = await res.json();

          appendLogs(data.logs);

          if (data.status === 'completed') {
            clearInterval(pollTimer);
            sessionStorage.removeItem('activeSearchId');
            if (data.total === 0) {
              // No viable businesses — reset progress bar and prompt new search
              progressWrap.classList.remove('open');
              window.progressStage = -1;
        
              if (typeof window.updateProgressBar === 'function') window.updateProgressBar(-1);
              statusEl.textContent = 'All businesses already have websites — try a different search.';
              searchInput.focus();
            } else {
              statusEl.textContent = `${data.total} total`;
              loadResults(searchId);
            }
          } else if (data.status === 'failed') {
            clearInterval(pollTimer);
            sessionStorage.removeItem('activeSearchId');
            statusEl.textContent = 'Search failed.';
          } else {
            const progress = data.total > 0 ? ` ${data.completed}/${data.total}` : '';
            statusEl.innerHTML = `<span class="spinner"></span>${progress}`;
          }
        } catch {
          clearInterval(pollTimer);
          sessionStorage.removeItem('activeSearchId');
          statusEl.textContent = 'Connection lost.';
        }
      }, 2000);
    }

    async function loadResults(searchId) {
      try {
        const res = await fetch(`/api/results/${searchId}`);
        const businesses = await res.json();

        cardsEl.innerHTML = '';
        for (const biz of businesses) {
          renderCard(biz, cardsEl, false);
        }

        if (businesses.length === 0) {
          statusEl.textContent = 'No businesses without websites found.';
        }
      } catch {
        statusEl.textContent = 'Failed to load results.';
      }
    }

    // --- card rendering ---
    function renderCard(biz, container, isSaved) {
      const card = document.createElement('div');
      card.className = `card${isSaved ? ' saved' : ''}${biz._building ? ' building' : ''}`;
      card.dataset.id = biz.id;

      const hasEmail = biz.email && biz.email !== 'null';
      const liveUrl3d = biz.live_url_3d || '';
      const liveUrlClassic = biz.live_url_classic || '';
      const hasAnyUrl = liveUrl3d || liveUrlClassic;

      // Build condensed address: just city-level
      const addressShort = biz.address ? esc(biz.address) : '';

      // Email draft text (hidden, used for popover)
      const draft = hasEmail && hasAnyUrl
        ? `Subject: We built you a free website — pick your favorite\n\nHi ${biz.name},\n\nWe noticed you didn't have a website so we built two options for you:\n${liveUrl3d ? `\nOption A (Interactive 3D): ${liveUrl3d}` : ''}${liveUrlClassic ? `\nOption B (Classic): ${liveUrlClassic}` : ''}\n\nTake a look and let us know which one you prefer — or if you'd like any changes.\n\n— Platter`
        : '';

      const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m0 0a9.06 9.06 0 011.5-.124H15a3.75 3.75 0 013.75 3.75v5.624"/></svg>`;
      const trashIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:16px;height:16px;"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"/></svg>`;

      card.innerHTML = `
        <div class="card-top">
          <div class="card-name">${esc(biz.name)}</div>
          <div style="display:flex;align-items:center;gap:0.5rem;">
            ${biz.google_rating ? `<div class="card-rating"><span class="star">&#9733;</span> ${biz.google_rating} (${biz.google_reviews})</div>` : ''}
            <button class="btn-icon" data-delete title="Delete" style="background:none;border:none;cursor:pointer;padding:4px;color:#94a3b8;display:flex;align-items:center;">${trashIcon}</button>
          </div>
        </div>
        <div class="card-meta">
          ${addressShort ? `<span>${addressShort}</span>` : ''}
        </div>
        <div class="card-meta" style="margin-top:0.4rem;">
          ${hasEmail ? `<button class="copy-chip" data-copy-contact="${esc(biz.email)}">${copyIcon} ${esc(biz.email)}</button>` : '<span style="color:#94a3b8">No email found</span>'}
          ${biz.phone ? `<button class="copy-chip" data-copy-contact="${esc(biz.phone)}">${copyIcon} ${esc(biz.phone)}</button>` : ''}
        </div>
        <div class="card-actions">
          ${liveUrl3d ? `<a href="${esc(liveUrl3d)}" target="_blank" class="btn btn-ghost" style="text-decoration:none;">Preview 3D</a>` : ''}
          ${liveUrlClassic ? `<a href="${esc(liveUrlClassic)}" target="_blank" class="btn btn-ghost" style="text-decoration:none;">Preview Classic</a>` : ''}
          ${hasEmail && hasAnyUrl ? `
            <div class="email-popover-wrap">
              <button class="btn btn-primary" data-copy>Copy Email Draft</button>
              <div class="email-popover">
                <div class="email-popover-label">Email Draft</div>
                <div class="email-popover-body">${esc(draft)}</div>
              </div>
            </div>
          ` : ''}
          ${!isSaved ? `<button class="btn btn-ghost" data-save>Save for Later</button>` : ''}
        </div>
        <div class="card-detail-popover">
          <dl>
            ${biz.description ? `<dt>About</dt><dd>${esc(biz.description)}</dd>` : ''}
            ${biz.style ? `<dt>Design Style</dt><dd>${esc(biz.style)}</dd>` : ''}
            ${biz.business_hours ? `<dt>Hours</dt><dd>${esc(biz.business_hours)}</dd>` : ''}
            ${biz.address ? `<dt>Address</dt><dd>${esc(biz.address)}</dd>` : ''}
            ${biz.social_media_links && biz.social_media_links.length ? `<dt>Social</dt><dd>${biz.social_media_links.map(u => `<a href="${esc(u)}" target="_blank" style="color:#6b9cf7;word-break:break-all;">${esc(u)}</a>`).join('<br>')}</dd>` : ''}
          </dl>
        </div>
      `;

      // store draft text for copying
      card._draft = draft;

      // copy email
      const copyBtn = card.querySelector('[data-copy]');
      if (copyBtn) {
        copyBtn.addEventListener('click', () => {
          // lock width so button doesn't resize on text change
          copyBtn.style.minWidth = copyBtn.offsetWidth + 'px';
          navigator.clipboard.writeText(card._draft).then(() => {
            copyBtn.textContent = 'Copied!';
            copyBtn.classList.add('btn-copied');
            copyBtn.classList.remove('btn-primary');
            setTimeout(() => {
              copyBtn.textContent = 'Copy Email Draft';
              copyBtn.classList.remove('btn-copied');
              copyBtn.classList.add('btn-primary');
            }, 2000);
          });
        });
      }

      // copy contact chips (email / phone)
      card.querySelectorAll('[data-copy-contact]').forEach(chip => {
        chip.addEventListener('click', () => {
          const val = chip.getAttribute('data-copy-contact');
          navigator.clipboard.writeText(val).then(() => {
            const orig = chip.innerHTML;
            chip.textContent = 'Copied!';
            chip.classList.add('copied');
            setTimeout(() => {
              chip.innerHTML = orig;
              chip.classList.remove('copied');
            }, 1500);
          });
        });
      });

      // save for later
      const saveBtn = card.querySelector('[data-save]');
      if (saveBtn) {
        saveBtn.addEventListener('click', async () => {
          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving...';
          try {
            await fetch(`/api/businesses/${biz.id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status: 'saved' })
            });
          } catch {}

          card.remove();
          savedItems.push(biz);
          updateSavedBadge();
          renderCard(biz, savedCardsEl, true);
        });
      }

      // delete
      const delBtn = card.querySelector('[data-delete]');
      if (delBtn) {
        delBtn.addEventListener('click', async () => {
          try {
            await fetch(`/api/businesses/${biz.id}`, { method: 'DELETE' });
          } catch {}
          card.remove();
        });
      }

      container.appendChild(card);
    }

    function updateSavedBadge() {
      savedCountEl.textContent = savedItems.length;
    }

    function esc(str) {
      const d = document.createElement('div');
      d.textContent = str || '';
      return d.innerHTML;
    }
  </script>

  <!-- Three.js 3D background -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/"
    }
  }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    const canvas = document.getElementById('bg-canvas');
    const configPanel = document.getElementById('sceneConfig');

    // --- config state ---
    const cfg = {
      show: true,
      rotSpeed: 0.0005,
      camDist: 13,
      camHeight: 5,
      scale: 2.0,
      lightIntensity: 2.2,
      opacity: 0.64,
    };

    // --- Three.js setup ---
    const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.2;

    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.set(0, cfg.camHeight, cfg.camDist);
    camera.lookAt(0, 0, 0);

    // --- warm lighting ---
    const ambient = new THREE.AmbientLight(0xfff0e0, 0.6);
    scene.add(ambient);

    // warm key light (sun-like)
    const keyLight = new THREE.DirectionalLight(0xffe4b5, cfg.lightIntensity);
    keyLight.position.set(5, 8, 4);
    keyLight.castShadow = false;
    scene.add(keyLight);

    // warm fill light
    const fillLight = new THREE.DirectionalLight(0xffd4a0, 0.5);
    fillLight.position.set(-4, 3, -2);
    scene.add(fillLight);

    // soft warm rim
    const rimLight = new THREE.PointLight(0xffb870, 0.4, 30);
    rimLight.position.set(0, 6, -6);
    scene.add(rimLight);

    // --- load model ---
    let model = null;
    const loader = new GLTFLoader();
    loader.load('/models/low_poly_nature.glb', (gltf) => {
      model = gltf.scene;
      model.scale.setScalar(cfg.scale);

      // center model
      const box = new THREE.Box3().setFromObject(model);
      const center = box.getCenter(new THREE.Vector3());
      model.position.sub(center);
      model.position.y -= 1;

      scene.add(model);
    });

    // --- animation loop ---
    function animate() {
      requestAnimationFrame(animate);

      if (!cfg.show) {
        canvas.style.opacity = '0';
        return;
      }

      canvas.style.opacity = String(cfg.opacity);

      if (model) {
        model.rotation.y += cfg.rotSpeed;
      }

      camera.position.set(0, cfg.camHeight, cfg.camDist);
      camera.lookAt(0, 0, 0);

      keyLight.intensity = cfg.lightIntensity;

      renderer.render(scene, camera);
    }

    animate();

    // --- resize ---
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // --- config panel toggle (Ctrl+D) ---
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        configPanel.classList.toggle('open');
      }
    });

    // --- config controls ---
    const cfgShow = document.getElementById('cfgShow');
    const cfgRotSpeed = document.getElementById('cfgRotSpeed');
    const cfgRotSpeedVal = document.getElementById('cfgRotSpeedVal');
    const cfgCamDist = document.getElementById('cfgCamDist');
    const cfgCamDistVal = document.getElementById('cfgCamDistVal');
    const cfgCamHeight = document.getElementById('cfgCamHeight');
    const cfgCamHeightVal = document.getElementById('cfgCamHeightVal');
    const cfgScale = document.getElementById('cfgScale');
    const cfgScaleVal = document.getElementById('cfgScaleVal');
    const cfgLightInt = document.getElementById('cfgLightInt');
    const cfgLightIntVal = document.getElementById('cfgLightIntVal');
    const cfgOpacity = document.getElementById('cfgOpacity');
    const cfgOpacityVal = document.getElementById('cfgOpacityVal');

    cfgShow.addEventListener('change', () => {
      cfg.show = cfgShow.checked;
    });

    cfgRotSpeed.addEventListener('input', () => {
      cfg.rotSpeed = cfgRotSpeed.value / 10000;
      cfgRotSpeedVal.textContent = cfg.rotSpeed.toFixed(4);
    });

    cfgCamDist.addEventListener('input', () => {
      cfg.camDist = Number(cfgCamDist.value);
      cfgCamDistVal.textContent = cfg.camDist;
    });

    cfgCamHeight.addEventListener('input', () => {
      cfg.camHeight = Number(cfgCamHeight.value);
      cfgCamHeightVal.textContent = cfg.camHeight;
    });

    cfgScale.addEventListener('input', () => {
      cfg.scale = cfgScale.value / 10;
      cfgScaleVal.textContent = cfg.scale.toFixed(1);
      if (model) model.scale.setScalar(cfg.scale);
    });

    cfgLightInt.addEventListener('input', () => {
      cfg.lightIntensity = cfgLightInt.value / 33.3;
      cfgLightIntVal.textContent = cfg.lightIntensity.toFixed(1);
    });

    cfgOpacity.addEventListener('input', () => {
      cfg.opacity = cfgOpacity.value / 100;
      cfgOpacityVal.textContent = cfg.opacity.toFixed(2);
    });

    // ---- 3D Progress Bar ----
    {
      const pCanvas = document.getElementById('progress-canvas');
      const pRenderer = new THREE.WebGLRenderer({ canvas: pCanvas, alpha: true, antialias: true });
      pRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

      const pScene = new THREE.Scene();

      const barCfg = { frustum: 4, segH: 0.4, segD: 0.25, gap: 0.06 };

      const aspect = pCanvas.clientWidth / pCanvas.clientHeight;
      const pCamera = new THREE.OrthographicCamera(
        -barCfg.frustum * aspect / 2, barCfg.frustum * aspect / 2,
        barCfg.frustum / 2, -barCfg.frustum / 2, 0.1, 50
      );
      pCamera.position.set(0, 2.5, 5);
      pCamera.lookAt(0, 0, 0);

      const pAmbient = new THREE.AmbientLight(0xfff5e6, 0.6);
      pScene.add(pAmbient);
      const pDir = new THREE.DirectionalLight(0xffe8cc, 1.0);
      pDir.position.set(3, 5, 4);
      pScene.add(pDir);
      const pWarm = new THREE.PointLight(0xffaa55, 0.8, 20);
      pWarm.position.set(-2, 2, 3);
      pScene.add(pWarm);
      const pWarm2 = new THREE.PointLight(0xff8833, 0.4, 20);
      pWarm2.position.set(3, 1, 2);
      pScene.add(pWarm2);

      const segCount = 5;
      const totalW = 6;
      const inactiveColor = 0xdde4ee;
      const activeColor = 0x6b9cf7;
      const labels = ['Search', 'Filter', 'Research', 'Generate', 'Deploy'];

      const barGroup = new THREE.Group();
      const boxes = [];
      const boxData = []; // { side, front, label }
      let currentStage = -1;

      function makeTextTex(text, bgHex, textHex) {
        const c = document.createElement('canvas');
        c.width = 256; c.height = 128;
        const ctx = c.getContext('2d');
        ctx.fillStyle = bgHex;
        ctx.fillRect(0, 0, 256, 128);
        ctx.fillStyle = textHex;
        ctx.font = 'bold 36px Inter, system-ui, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, 128, 64);
        const tex = new THREE.CanvasTexture(c);
        tex.minFilter = THREE.LinearFilter;
        return tex;
      }

      function buildBars() {
        // clear old
        while (barGroup.children.length) barGroup.remove(barGroup.children[0]);
        boxes.length = 0;
        boxData.length = 0;

        const segW = (totalW - barCfg.gap * (segCount - 1)) / segCount;
        for (let i = 0; i < segCount; i++) {
          const geo = new THREE.BoxGeometry(segW, barCfg.segH, barCfg.segD);
          const sideMat = new THREE.MeshStandardMaterial({ color: inactiveColor, flatShading: true });
          const frontMat = new THREE.MeshStandardMaterial({
            map: makeTextTex(labels[i], '#dde4ee', '#64748b'),
            flatShading: true
          });
          // BoxGeometry face order: +x, -x, +y, -y, +z, -z
          const mats = [sideMat, sideMat, sideMat, sideMat, frontMat, sideMat];
          const mesh = new THREE.Mesh(geo, mats);
          const x = -totalW / 2 + segW / 2 + i * (segW + barCfg.gap);
          mesh.position.set(x, 0, 0);
          barGroup.add(mesh);
          boxes.push(mesh);
          boxData.push({ side: sideMat, front: frontMat, label: labels[i] });
        }
        // re-apply current stage colors
        applyColors(currentStage);
      }

      pScene.add(barGroup);

      let activeOutline = null;

      function applyColors(stageIndex) {
        if (activeOutline) { barGroup.remove(activeOutline); activeOutline = null; }
        for (let i = 0; i < segCount; i++) {
          const active = stageIndex >= 0 && i <= stageIndex;
          boxData[i].side.color.setHex(active ? activeColor : inactiveColor);
          boxData[i].front.map.dispose();
          boxData[i].front.map = makeTextTex(
            boxData[i].label,
            active ? '#6b9cf7' : '#dde4ee',
            active ? '#ffffff' : '#64748b'
          );
          boxData[i].front.needsUpdate = true;
        }
        if (stageIndex >= 0 && stageIndex < segCount) {
          const edges = new THREE.EdgesGeometry(boxes[stageIndex].geometry);
          activeOutline = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000, linewidth: 1.5 }));
          activeOutline.position.copy(boxes[stageIndex].position);
          barGroup.add(activeOutline);
        }
      }

      function updateBar(stageIndex) {
        currentStage = stageIndex;
        if (boxData.length) applyColors(stageIndex);
      }

      window.updateProgressBar = updateBar;

      buildBars();

      function updateCamera() {
        const w = pCanvas.clientWidth;
        const h = pCanvas.clientHeight;
        if (w === 0 || h === 0) return;
        const a = w / h;
        pCamera.left = -barCfg.frustum * a / 2;
        pCamera.right = barCfg.frustum * a / 2;
        pCamera.top = barCfg.frustum / 2;
        pCamera.bottom = -barCfg.frustum / 2;
        pCamera.updateProjectionMatrix();
        pRenderer.setSize(w, h, false);
      }

      // --- debug controls ---
      const cfgBarH = document.getElementById('cfgBarH');
      const cfgBarHVal = document.getElementById('cfgBarHVal');
      const cfgSegH = document.getElementById('cfgSegH');
      const cfgSegHVal = document.getElementById('cfgSegHVal');
      const cfgSegD = document.getElementById('cfgSegD');
      const cfgSegDVal = document.getElementById('cfgSegDVal');
      const cfgBarGap = document.getElementById('cfgBarGap');
      const cfgBarGapVal = document.getElementById('cfgBarGapVal');
      const cfgFrustum = document.getElementById('cfgFrustum');
      const cfgFrustumVal = document.getElementById('cfgFrustumVal');

      cfgBarH.addEventListener('input', () => {
        const v = parseInt(cfgBarH.value);
        cfgBarHVal.textContent = v;
        pCanvas.style.height = v + 'px';
        updateCamera();
      });
      cfgSegH.addEventListener('input', () => {
        barCfg.segH = parseInt(cfgSegH.value) / 100;
        cfgSegHVal.textContent = barCfg.segH.toFixed(2);
        buildBars();
      });
      cfgSegD.addEventListener('input', () => {
        barCfg.segD = parseInt(cfgSegD.value) / 100;
        cfgSegDVal.textContent = barCfg.segD.toFixed(2);
        buildBars();
      });
      cfgBarGap.addEventListener('input', () => {
        barCfg.gap = parseInt(cfgBarGap.value) / 100;
        cfgBarGapVal.textContent = barCfg.gap.toFixed(2);
        buildBars();
      });
      cfgFrustum.addEventListener('input', () => {
        barCfg.frustum = parseInt(cfgFrustum.value) / 10;
        cfgFrustumVal.textContent = barCfg.frustum.toFixed(1);
        updateCamera();
      });

      const cfgBarX = document.getElementById('cfgBarX');
      const cfgBarXVal = document.getElementById('cfgBarXVal');
      const cfgBarY = document.getElementById('cfgBarY');
      const cfgBarYVal = document.getElementById('cfgBarYVal');
      const cfgBarZ = document.getElementById('cfgBarZ');
      const cfgBarZVal = document.getElementById('cfgBarZVal');
      const cfgBarScale = document.getElementById('cfgBarScale');
      const cfgBarScaleVal = document.getElementById('cfgBarScaleVal');

      cfgBarX.addEventListener('input', () => {
        const v = parseInt(cfgBarX.value) / 100;
        cfgBarXVal.textContent = v.toFixed(1);
        barGroup.position.x = v;
      });
      cfgBarY.addEventListener('input', () => {
        const v = parseInt(cfgBarY.value) / 100;
        cfgBarYVal.textContent = v.toFixed(1);
        barGroup.position.y = v;
      });
      cfgBarZ.addEventListener('input', () => {
        const v = parseInt(cfgBarZ.value) / 100;
        cfgBarZVal.textContent = v.toFixed(1);
        barGroup.position.z = v;
      });
      cfgBarScale.addEventListener('input', () => {
        const v = parseInt(cfgBarScale.value) / 100;
        cfgBarScaleVal.textContent = v.toFixed(1);
        barGroup.scale.setScalar(v);
      });

      let lastW = 0, lastH = 0;

      function progressLoop() {
        requestAnimationFrame(progressLoop);
        const w = pCanvas.clientWidth;
        const h = pCanvas.clientHeight;
        if (w === 0 || h === 0) return;
        if (w !== lastW || h !== lastH) {
          lastW = w; lastH = h;
          updateCamera();
        }
        pRenderer.render(pScene, pCamera);
      }
      progressLoop();
    }
  </script>
</body>
</html>
